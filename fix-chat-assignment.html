<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Arreglar Asignaci√≥n de Chat</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 600px;
            margin: 50px auto;
            padding: 20px;
            background-color: #1a1a1a;
            color: #fff;
        }
        .container {
            background: #2a2a2a;
            padding: 30px;
            border-radius: 10px;
            box-shadow: 0 4px 6px rgba(0, 0, 0, 0.3);
        }
        button {
            background: #3b82f6;
            color: white;
            border: none;
            padding: 12px 24px;
            border-radius: 8px;
            cursor: pointer;
            margin: 10px 5px;
            font-size: 16px;
        }
        button:hover {
            background: #2563eb;
        }
        button:disabled {
            background: #6b7280;
            cursor: not-allowed;
        }
        .result {
            margin-top: 20px;
            padding: 15px;
            border-radius: 8px;
            white-space: pre-wrap;
        }
        .success {
            background: #065f46;
            border: 1px solid #10b981;
        }
        .error {
            background: #7f1d1d;
            border: 1px solid #ef4444;
        }
        .info {
            background: #1e3a8a;
            border: 1px solid #3b82f6;
        }
        .warning {
            background: #92400e;
            border: 1px solid #f59e0b;
        }
        h1 {
            color: #3b82f6;
            text-align: center;
        }
        .user-info {
            background: #374151;
            padding: 15px;
            border-radius: 8px;
            margin: 15px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>üîß Arreglar Asignaci√≥n de Chat</h1>

        <div class="user-info">
            <h3>Tu informaci√≥n actual:</h3>
            <p><strong>Email:</strong> sanchezguevaravalentin@gmail.com</p>
            <p><strong>Nombre:</strong> Valentin S√°nchez Guevara</p>
            <p><strong>Manzana:</strong> 3</p>
            <p><strong>Lote:</strong> 33</p>
            <p><strong>Barrio calculado:</strong> Barrio 0 (Math.floor(3/10) = 0)</p>
        </div>

        <div style="text-align: center;">
            <button onclick="checkStatus()">1. Verificar Estado Actual</button>
            <button onclick="fixAssignment()" id="fixBtn">2. Asignar al Chat del Barrio</button>
            <button onclick="testChatAPI()">3. Probar Chat API</button>
        </div>

        <div id="result"></div>
    </div>

    <script>
        const API_BASE = window.location.origin;

        function showResult(message, type = 'info') {
            const resultDiv = document.getElementById('result');
            resultDiv.className = `result ${type}`;
            resultDiv.textContent = message;
        }

        async function checkStatus() {
            try {
                showResult('Verificando estado...', 'info');

                const response = await fetch(`${API_BASE}/api/chat/fix-user`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    let message = `Estado actual:
‚úÖ Onboarding: ${data.hasOnboarding ? 'Completo' : 'Pendiente'}
‚úÖ Manzana: ${data.hasBlockNumber ? data.currentData.blockNumber : 'No definida'}
‚úÖ Lote: ${data.hasLotNumber ? data.currentData.lotNumber : 'No definido'}
${data.hasNeighborhood ? '‚úÖ' : '‚ùå'} Barrio: ${data.currentData.neighborhood || 'No asignado'}
${data.hasChatId ? '‚úÖ' : '‚ùå'} Chat ID: ${data.currentData.chatId || 'No asignado'}

${data.needsAssignment ? '‚ö†Ô∏è NECESITA ASIGNACI√ìN' : '‚úÖ TODO CORRECTO'}

Acci√≥n recomendada: ${data.recommendedAction}`;

                    showResult(message, data.needsAssignment ? 'warning' : 'success');
                } else {
                    showResult(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function fixAssignment() {
            try {
                showResult('Asignando al chat del barrio...', 'info');

                const response = await fetch(`${API_BASE}/api/chat/fix-user`, {
                    method: 'POST',
                    credentials: 'include',
                    headers: {
                        'Content-Type': 'application/json'
                    }
                });

                const result = await response.json();

                if (result.success) {
                    const data = result.data;
                    let message = `¬°√âxito! üéâ

Usuario: ${data.userName}
Email: ${data.userEmail}
Barrio asignado: ${data.neighborhood}
Chat ID: ${data.chatId}
Ubicaci√≥n: Manzana ${data.blockNumber}, Lote ${data.lotNumber}

¬°Ya puedes usar el chat de tu barrio!`;

                    showResult(message, 'success');
                } else {
                    showResult(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        async function testChatAPI() {
            try {
                showResult('Probando API del chat...', 'info');

                const response = await fetch(`${API_BASE}/api/chat/mine`, {
                    method: 'GET',
                    credentials: 'include'
                });

                const result = await response.json();

                if (result.success) {
                    if (result.data) {
                        const chat = result.data;
                        let message = `Chat encontrado! üéâ

Barrio: ${chat.neighborhood}
Participantes: ${chat.participantsCount}
Chat ID: ${chat.chatId}

Vecinos en tu barrio:`;

                        chat.participants.forEach(p => {
                            message += `\n- ${p.name} ${p.surname} (Manzana ${p.blockNumber})`;
                        });

                        showResult(message, 'success');
                    } else {
                        showResult('No tienes un chat asignado a√∫n. Usa el bot√≥n "Asignar al Chat del Barrio" primero.', 'warning');
                    }
                } else {
                    showResult(`Error: ${result.message}`, 'error');
                }
            } catch (error) {
                showResult(`Error de conexi√≥n: ${error.message}`, 'error');
            }
        }

        // Verificar estado al cargar la p√°gina
        window.onload = function() {
            showResult('P√°gina cargada. Haz clic en "Verificar Estado Actual" para empezar.', 'info');
        };
    </script>
</body>
</html>
